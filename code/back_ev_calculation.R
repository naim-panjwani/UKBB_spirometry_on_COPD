blow_start_quality <- function(blow_curve) {
  # PRE: 
  ##  blow_curve is a string of length 1 and as defined in UKBB showcase variable ID 3066 (https://biobank.ndph.ox.ac.uk/showcase/field.cgi?id=3066)
  ##  fvc is the corresponding FVC value for corresponding individual as calculated by UKBB (variable ID: 3062)
  # POST:
  ##  returns a TRUE if start of blow passes according to the back-extrapolated volume (EV) calculated (i.e. EV < 5% of FVC or EV < 150mL); FALSE otherwise

  blow_curve <- as.character(blow_curve)
  if(length(blow_curve)>1) stop(paste0("String of length 1 expected for blow_curve input, found length of ",length(blow_curve)," instead"))
  if(is.na(blow_curve) | is.null(blow_curve)) return(NA)
  if(blow_curve=="") return(NA)

  blow_curve <- strsplit(blow_curve,",")[[1]]
  #blow_num <- as.integer(gsub("blow","",blow_curve[1]))
  #n_blows <- as.integer(blow_curve[2])
  y <- as.integer(blow_curve[3:length(blow_curve)])
  times <- seq(0, length(y)*10-10, by=10)
  
  i <- seq(1,length(y)-1)
  dy <- y[i+1] - y[i]
  dt <- times[i+1] - times[i]
  dydt <- dy/dt
  m <- max(dydt)
  m_idx <- which(dydt %in% m)
  if(length(m_idx)>1) {
    l <- length(m_idx)
    even <- (l %% 2) == 0
    if(!even) l <- l + 1
    m_idx <- m_idx[l/2]
  }
  time_at_idx <- times[m_idx]
  y_at_idx <- y[m_idx]
  b <- y_at_idx - m*time_at_idx
  time_intercept <- round(-b/m)
  modulo <- time_intercept %% 10
  quotient <- floor(time_intercept/10)*10
  y_at_t <- NULL
  if(modulo != 0) {
    t2 <- quotient+10
    t1 <- quotient
    idx <- which(times %in% t1)
    y2 <- y[idx+1]
    y1 <- y[idx]
    m <- (y2-y1)/(t2-t1)
    b <- y2 - m*t2
    y_at_t <- m*time_intercept+b # EV: back-extrapolated volume (in mL)
  } else {
    idx <- which(times %in% time_intercept)
    y_at_t <- y[idx] # EV: back-extrapolated volume (in mL)
  }
  ev <- y_at_t
  fvc <- max(y)
  # print(paste("ev:",ev,"fvc:",fvc))
  blow_pass <- TRUE
  if((ev>(0.05*fvc)) | (ev>150)) {
    blow_pass <- FALSE
  }
  return(blow_pass)
}

# fvc <- c(3.75,3.55,3.45)
# blow_pass <- blow_start_quality(blow, fvc)


# blow <- "blow3,827,0,0,0,0,1,5,11,18,28,40,58,80,109,144,182,224,268,314,361,409,458,507,556,605,655,705,756,807,859,910,961,1012,1061,1110,1158,1206,1253,1300,1347,1394,1441,1487,1534,1580,1627,1673,1719,1764,1808,1852,1895,1937,1978,2019,2059,2099,2139,2177,2214,2250,2286,2320,2354,2387,2419,2450,2480,2507,2533,2557,2580,2602,2624,2646,2667,2687,2706,2726,2744,2762,2779,2796,2812,2827,2841,2856,2869,2882,2895,2908,2920,2931,2943,2953,2964,2974,2984,2993,3002,3011,3019,3028,3036,3044,3051,3058,3065,3072,3079,3086,3092,3098,3104,3110,3116,3122,3127,3133,3138,3143,3149,3154,3159,3164,3168,3173,3178,3183,3187,3192,3196,3201,3205,3209,3213,3218,3222,3226,3230,3234,3238,3242,3246,3250,3253,3257,3260,3264,3268,3271,3274,3278,3281,3284,3288,3291,3294,3297,3300,3303,3306,3309,3311,3314,3317,3320,3323,3326,3329,3331,3334,3337,3340,3342,3345,3347,3350,3352,3354,3357,3359,3361,3364,3366,3368,3370,3372,3374,3376,3378,3380,3382,3384,3386,3388,3390,3392,3394,3396,3398,3399,3401,3403,3404,3406,3408,3410,3411,3413,3415,3416,3418,3419,3421,3422,3424,3425,3427,3428,3430,3432,3433,3435,3436,3437,3439,3440,3442,3443,3445,3446,3448,3449,3451,3452,3453,3455,3456,3457,3459,3460,3461,3462,3463,3465,3466,3467,3468,3470,3471,3472,3474,3475,3476,3478,3479,3480,3482,3483,3484,3486,3487,3488,3489,3491,3492,3493,3494,3495,3496,3497,3499,3500,3501,3502,3503,3504,3505,3506,3507,3508,3509,3510,3511,3512,3513,3514,3515,3516,3517,3518,3519,3520,3521,3522,3523,3524,3524,3525,3526,3527,3528,3529,3530,3530,3531,3532,3533,3534,3535,3536,3536,3537,3538,3539,3540,3541,3542,3542,3543,3544,3545,3546,3546,3547,3548,3549,3550,3550,3551,3552,3552,3553,3554,3555,3555,3556,3557,3558,3559,3559,3560,3561,3562,3563,3563,3564,3565,3566,3566,3567,3568,3569,3570,3571,3571,3572,3573,3574,3574,3575,3576,3576,3577,3578,3579,3579,3580,3581,3581,3582,3583,3583,3584,3585,3585,3586,3586,3587,3588,3589,3589,3590,3590,3591,3592,3592,3593,3594,3594,3595,3596,3596,3597,3598,3598,3599,3600,3600,3601,3601,3602,3603,3603,3604,3605,3605,3606,3606,3607,3608,3608,3609,3609,3610,3611,3611,3612,3612,3613,3613,3614,3614,3615,3616,3616,3617,3617,3618,3619,3619,3620,3620,3621,3622,3622,3623,3624,3624,3625,3626,3626,3627,3627,3628,3629,3629,3630,3630,3631,3631,3632,3632,3633,3634,3634,3635,3635,3636,3636,3637,3638,3638,3639,3639,3640,3640,3641,3641,3642,3642,3643,3643,3644,3644,3645,3646,3646,3647,3647,3648,3648,3649,3649,3650,3650,3650,3651,3651,3652,3652,3653,3653,3654,3654,3655,3655,3656,3656,3657,3657,3658,3658,3659,3659,3660,3660,3660,3661,3661,3662,3662,3663,3663,3664,3664,3665,3665,3666,3666,3667,3667,3668,3669,3669,3670,3670,3671,3671,3672,3672,3673,3673,3674,3674,3675,3675,3675,3676,3676,3677,3677,3678,3678,3679,3679,3680,3680,3681,3681,3681,3682,3682,3683,3683,3683,3684,3684,3685,3685,3685,3686,3686,3687,3687,3688,3688,3688,3689,3689,3690,3690,3690,3691,3691,3691,3692,3692,3693,3693,3693,3694,3694,3694,3695,3695,3696,3696,3696,3697,3697,3697,3698,3698,3698,3699,3699,3699,3700,3700,3701,3701,3702,3702,3702,3703,3703,3704,3704,3705,3705,3706,3706,3707,3707,3707,3708,3708,3709,3709,3709,3710,3710,3710,3711,3711,3711,3712,3712,3712,3713,3713,3714,3714,3714,3715,3715,3715,3716,3716,3716,3717,3717,3717,3718,3718,3718,3719,3719,3719,3720,3720,3721,3721,3721,3722,3722,3722,3723,3723,3723,3724,3724,3724,3725,3725,3725,3726,3726,3726,3727,3727,3727,3728,3728,3728,3728,3729,3729,3730,3730,3730,3731,3731,3731,3732,3732,3732,3733,3733,3734,3734,3734,3735,3735,3735,3736,3736,3736,3737,3737,3737,3738,3738,3738,3739,3739,3739,3739,3740,3740,3740,3741,3741,3741,3742,3742,3742,3742,3743,3743,3743,3743,3743,3744,3744,3744,3744,3744,3744,3744,3745,3745,3745,3745,3745,3745,3745,3745,3745,3745,3746,3746,3746,3746,3746,3746,3745,3745,3745,3745,3744,3744,3743,3743,3742,3742,3742,3742,3742,3742,3742,3741,3741,3741,3741,3741,3741,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3740,3739,3739,3739,3739,3739,3739,3739,3739,3739,3739,3738,3738,3738,3738,3738,3738,3738,3738,3738,3738,3738"
